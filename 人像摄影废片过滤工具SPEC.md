# 人像摄影废片过滤工具 SPEC 文档

## 1. 项目概述

### 1.1 项目背景
在专业人像摄影中，摄影师通常会拍摄大量照片，其中包含大量废片（如闭眼、模糊、表情不佳等）。手动筛选这些照片既耗时又容易出错。本项目旨在开发一个自动化工具，帮助摄影师快速筛选和过滤人像摄影中的废片。

### 1.2 项目目标
- 自动检测和标记人像摄影中的废片
- 提供多维度的质量评估指标
- 支持批量处理大量照片
- 提供直观的结果展示和导出功能
- 减少人工筛选时间至少 80%

### 1.3 目标用户
- 专业人像摄影师
- 婚礼摄影师
- 商业摄影工作室
- 个人摄影爱好者

## 2. 功能需求

### 2.1 核心功能

#### 2.1.1 废片检测
**闭眼检测**
- 检测人物眼睛是否闭合
- 支持多人像场景中的多目标检测
- 提供闭眼程度的量化评分（0-100%）
- 阈值可配置

**模糊检测**
- 检测照片整体模糊程度
- 检测人物面部模糊程度
- 使用拉普拉斯方差等方法评估清晰度
- 提供模糊评分（0-100分）

**表情检测**
- 检测不自然或糟糕的表情
- 基于面部关键点分析表情质量
- 提供表情质量评分

**曝光检测**
- 检测过曝或欠曝照片
- 评估整体曝光质量
- 检测面部区域曝光是否合适
- 提供曝光评分

#### 2.1.2 批量处理
- 支持选择文件夹批量导入照片
- 支持常见图片格式（JPG, PNG, HEIC, RAW等）
- 显示处理进度
- 支持暂停、继续、取消操作
- 多线程/多进程处理以提高效率

#### 2.1.3 结果展示
- 以缩略图网格形式展示所有照片
- 不同标记类型的照片使用不同颜色标识
- 显示每张照片的详细评分信息
- 支持按评分、标签等条件筛选
- 支持图片放大预览
- 显示检测到的问题具体描述

#### 2.1.4 导出与管理
- 将废片移动到单独的文件夹
- 将优质照片移动到单独的文件夹
- 保留原照片文件夹结构
- 生成详细的筛选报告（CSV/JSON格式）
- 支持自定义导出规则

### 2.2 辅助功能

#### 2.2.1 配置管理
- 保存用户偏好设置
- 自定义各项检测阈值
- 保存常用的筛选规则
- 导入/导出配置文件

#### 2.2.2 历史记录
- 记录每次筛选任务
- 查看历史筛选结果
- 支持撤销/重做操作
- 查看处理统计信息

#### 2.2.3 手动校准与反馈学习
- 支持用户手动调整检测结果
- 添加手动标记功能（标记废片/有效照片）
- 提供快捷键操作
- 批量修改标记
- **反馈数据记录**: 记录用户手动校正的决策
- **持续学习**: 基于用户反馈优化检测模型
- **模型重训练**: 定期使用新收集的反馈数据训练模型
- **准确率追踪**: 记录模型准确率随时间的变化

## 3. 非功能需求

### 3.1 性能要求
- 单张照片处理时间 < 2秒（1080P分辨率）
- 支持4000+张照片的批量处理
- 内存占用 < 6GB
- CPU利用率合理，不卡顿系统

### 3.2 准确性要求
- 闭眼检测准确率 > 90%
- 模糊检测准确率 > 85%
- 表情检测准确率 > 80%
- 整体误判率 < 10%

### 3.3 易用性要求
- 界面简洁直观，学习曲线低
- 关键操作不超过3步
- 提供清晰的操作指引
- 支持中英文界面切换

### 3.4 可靠性要求
- 程序崩溃率 < 0.1%
- 数据不丢失，支持断点续传
- 异常情况有明确提示
- 提供详细的日志记录

### 3.5 兼容性要求
- 支持Windows 10/11
- 支持macOS 11+
- 支持常见图片格式
- 支持RAW格式（至少主流相机品牌）

## 4. 技术方案

### 4.1 技术栈选择

#### 编程语言
- **Python 3.9+**: 主要开发语言
  - 丰富的图像处理库
  - 机器学习/深度学习生态完善
  - 跨平台支持好

#### 核心库
- **OpenCV**: 图像处理基础
- **MediaPipe**: 人脸检测和关键点提取
- **Pillow/PIL**: 图片读写和基础处理
- **NumPy**: 数值计算
- **scikit-image**: 图像质量评估算法

#### 后端框架
- **FastAPI/Flask**: Web后端框架
  - 高性能异步处理
  - 自动生成API文档
  - 易于部署和维护

#### 前端框架
- **React**: 现代前端框架
  - 组件化开发
  - 响应式设计
  - 良好的用户体验

#### 前端UI组件库
- **Element Plus**: UI组件库
  - 丰富的预置组件
  - 美观的界面设计
  - 快速开发

#### 机器学习框架
- **PyTorch**: 深度学习框架
  - 灵活的模型定义
  - 丰富的预训练模型
  - 易于部署和优化
- **torchvision**: 计算机视觉工具包
  - 图像增强和预处理
  - 常用模型架构
- **scikit-learn**: 传统机器学习算法
  - 用于轻量级模型
  - 特征工程工具

#### 模型优化
- **ONNX Runtime**: 模型推理加速
  - 跨平台部署
  - 性能优化
- **TensorRT**: GPU加速（可选）

### 4.2 系统架构

```
┌─────────────────────────────────────────┐
│          前端 (React Web界面)            │
│  ┌─────────────────────────────────┐   │
│  │  照片上传  - 结果展示  - 配置   │   │
│  │  照片网格  - 筛选  - 手动标记   │   │
│  │  导出管理  - 历史记录           │   │
│  └──────────────┬──────────────────┘   │
└─────────────────┼───────────────────────┘
                  │ HTTP/WebSocket
┌─────────────────▼───────────────────────┐
│        后端 API (FastAPI)               │
│  ┌─────────────────────────────────┐   │
│  │  RESTful API  - WebSocket      │   │
│  │  任务管理  - 配置管理          │   │
│  └──────────────┬──────────────────┘   │
└─────────────────┼───────────────────────┘
                  │
┌─────────────────▼───────────────────────┐
│          业务逻辑层                      │
│  - 任务调度  - 数据管理  - 结果处理     │
└─────────────────┬───────────────────────┘
                  │
┌─────────────────▼───────────────────────┐
│          检测引擎层                      │
│  ┌──────┬──────┬──────┬─────┬│
│  │闭眼  │模糊  │表情  │曝光  │  
│  │检测  │检测  │检测  │检测  │  
│  └──────┴──────┴──────┴─────┴  │
└─────────────────┬───────────────────────┘
                  │
┌─────────────────▼───────────────────────┐
│          数据访问层                      │
│  - 文件读写  - 数据存储  - 配置管理     │
└─────────────────────────────────────────┘
```

### 4.3 前后端交互

#### API设计原则
- RESTful API风格
- JSON数据交换格式
- WebSocket用于实时进度推送
- 文件上传使用multipart/form-data

#### 主要API端点
```
POST   /api/upload          # 上传照片
POST   /api/tasks/start     # 启动检测任务
GET    /api/tasks/{id}      # 获取任务状态
GET    /api/tasks/{id}/progress  # 实时进度(WebSocket)
GET    /api/photos          # 获取照片列表
GET    /api/photos/{id}     # 获取照片详情
PUT    /api/photos/{id}     # 更新照片标记
DELETE /api/photos/{id}     # 删除照片
POST   /api/export          # 导出结果
GET    /api/config          # 获取配置
PUT    /api/config          # 更新配置
GET    /api/history         # 获取历史记录
```

### 4.4 文件组织结构

```
PictureFilter/
├── backend/                 # Python后端
│   ├── app/
│   │   ├── __init__.py
│   │   ├── main.py          # FastAPI应用入口
│   │   ├── api/
│   │   │   ├── __init__.py
│   │   │   ├── upload.py    # 文件上传API
│   │   │   ├── tasks.py     # 任务管理API
│   │   │   ├── photos.py    # 照片管理API
│   │   │   ├── export.py    # 导出API
│   │   │   ├── config.py    # 配置管理API
│   │   │   └── feedback.py  # 反馈学习API
│   │   ├── models/
│   │   │   ├── __init__.py
│   │   │   ├── photo.py     # 照片数据模型
│   │   │   ├── detection.py # 检测结果模型
│   │   │   ├── task.py      # 任务模型
│   │   │   └── feedback.py  # 反馈数据模型
│   │   ├── detectors/
│   │   │   ├── __init__.py
│   │   │   ├── base_detector.py  # 检测器基类
│   │   │   ├── eye_detector.py   # 闭眼检测
│   │   │   ├── blur_detector.py  # 模糊检测
│   │   │   ├── expression_detector.py  # 表情检测
│   │   │   ├── exposure_detector.py   # 曝光检测
│   │   │   └── composition_detector.py # 构图检测
│   │   ├── core/
│   │   │   ├── __init__.py
│   │   │   ├── processor.py  # 处理引擎
│   │   │   └── export.py     # 导出功能
│   │   ├── ml/
│   │   │   ├── __init__.py
│   │   │   ├── feedback_collector.py  # 反馈收集
│   │   │   ├── data_preparer.py      # 数据准备
│   │   │   ├── model_trainer.py      # 模型训练
│   │   │   ├── model_evaluator.py    # 模型评估
│   │   │   └── model_updater.py      # 模型更新
│   │   ├── utils/
│   │   │   ├── __init__.py
│   │   │   ├── image_utils.py    # 图像处理工具
│   │   │   ├── file_utils.py     # 文件操作工具
│   │   │   └── config.py         # 配置管理
│   │   └── websocket/
│   │       ├── __init__.py
│   │       └── progress.py   # WebSocket进度推送
│   ├── tests/
│   │   ├── test_detectors.py
│   │   ├── test_models.py
│   │   ├── test_api.py
│   │   └── test_ml.py        # 机器学习测试
│   ├── resources/
│   │   ├── models/          # 预训练模型
│   │   └── training_data/   # 训练数据
│   ├── requirements.txt
│   └── config.yaml         # 配置文件
│
├── frontend/                # React前端
│   ├── public/
│   │   ├── index.html
│   │   └── favicon.ico
│   ├── src/
│   │   ├── App.jsx         # 主应用组件
│   │   ├── main.jsx        # 入口文件
│   │   ├── components/
│   │   │   ├── PhotoGrid.jsx      # 照片网格组件
│   │   │   ├── PhotoCard.jsx      # 照片卡片组件
│   │   │   ├── UploadPanel.jsx    # 上传面板组件
│   │   │   ├── PreviewModal.jsx   # 预览模态框组件
│   │   │   ├── ProgressBar.jsx   # 进度条组件
│   │   │   ├── FilterPanel.jsx    # 筛选面板组件
│   │   │   ├── ExportPanel.jsx    # 导出面板组件
│   │   │   ├── ConfigDialog.jsx   # 配置对话框组件
│   │   │   ├── HistoryPanel.jsx   # 历史记录组件
│   │   │   └── FeedbackPanel.jsx  # 反馈面板组件
│   │   ├── services/
│   │   │   ├── api.js        # API服务
│   │   │   └── websocket.js  # WebSocket服务
│   │   ├── hooks/
│   │   │   ├── useTasks.js   # 任务管理Hook
│   │   │   ├── useProgress.js # 进度Hook
│   │   │   └── useFeedback.js # 反馈管理Hook
│   │   ├── store/
│   │   │   └── index.js     # 状态管理
│   │   └── styles/
│   │       └── global.css   # 全局样式
│   ├── package.json
│   └── vite.config.js       # Vite配置
│
├── uploads/                 # 上传文件临时存储
├── output/                  # 输出文件目录
├── data/                    # 数据存储
│   ├── history/             # 历史记录
│   └── feedback/            # 反馈数据
│       ├── corrections.json  # 校正记录
│       └── metrics.json     # 准确率指标
├── docs/
│   ├── user_guide.md
│   ├── api_reference.md
│   ├── deployment.md        # 部署文档
│   └── ml_guide.md         # 机器学习指南
├── docker/
│   ├── Dockerfile.backend
│   ├── Dockerfile.frontend
│   └── docker-compose.yml
├── .gitignore
├── README.md
└── run.py                  # 启动脚本
```

### 4.5 反馈学习系统设计

#### 4.5.1 反馈数据模型
```python
class Feedback:
    """用户反馈数据模型"""
    def __init__(self, photo_id, user_decision, original_prediction, timestamp):
        self.id = generate_uuid()
        self.photo_id = photo_id  # 照片ID
        self.user_decision = user_decision  # 用户决策：'good' 或 'bad'
        self.original_prediction = original_prediction  # 原始检测结果
        self.features = extract_features(photo_id)  # 提取的特征
        self.timestamp = timestamp
        self.used_in_training = False  # 是否已用于训练
```

#### 4.5.2 反馈收集流程
```
用户浏览废片
    ↓
用户手动标记（废片→有效 或 有效→废片）
    ↓
前端发送反馈到后端 API
    ↓
后端记录反馈到数据库
    ↓
提取照片特征向量
    ↓
存入训练数据集
```

#### 4.5.3 模型重训练流程
```
触发条件：
  - 累积反馈数据达到N条（如500条）
  - 或者手动触发训练

数据准备：
  1. 加载反馈数据
  2. 数据增强（旋转、裁剪、亮度调整等）
  3. 划分训练集/验证集（8:2）

模型训练：
  1. 加载当前模型作为基础
  2. 使用反馈数据进行微调（Fine-tuning）
  3. 监控验证集准确率
  4. 保存最佳模型

模型评估：
  1. 在测试集上评估新模型
  2. 对比旧模型性能
  3. 如果准确率提升，则部署新模型

部署更新：
  1. 热更新模型文件
  2. 无需重启服务
  3. 记录更新日志
```

#### 4.5.4 准确率追踪系统
```python
class AccuracyTracker:
    """准确率追踪器"""
    def __init__(self):
        self.metrics = []
    
    def record_feedback(self, prediction, user_decision):
        """记录反馈数据"""
        is_correct = (prediction == user_decision)
        self.metrics.append({
            'timestamp': datetime.now(),
            'is_correct': is_correct,
            'confidence': prediction.confidence
        })
    
    def calculate_accuracy(self, window_size=100):
        """计算滑动窗口准确率"""
        recent_metrics = self.metrics[-window_size:]
        correct = sum(1 for m in recent_metrics if m['is_correct'])
        return correct / len(recent_metrics) if recent_metrics else 0
    
    def get_accuracy_trend(self):
        """获取准确率趋势"""
        window_sizes = [10, 50, 100, 500]
        return {
            size: self.calculate_accuracy(size)
            for size in window_sizes
        }
```

#### 4.5.5 模型训练API端点
```
POST   /api/feedback/record       # 记录用户反馈
GET    /api/feedback/list         # 获取反馈列表
GET    /api/feedback/stats        # 获取反馈统计
POST   /api/ml/train/start        # 启动模型训练
GET    /api/ml/train/status       # 获取训练状态
GET    /api/ml/metrics           # 获取模型指标
GET    /api/ml/accuracy/trend    # 获取准确率趋势
```

#### 4.5.6 数据增强策略
为了充分利用有限的反馈数据，使用数据增强技术：
- **几何变换**: 随机旋转（±15°）、水平翻转、随机裁剪
- **颜色变换**: 亮度调整（±20%）、对比度调整（±20%）、饱和度调整
- **噪声添加**: 高斯噪声、椒盐噪声（少量）
- **模糊模拟**: 轻微高斯模糊（模拟拍摄条件）

#### 4.5.7 模型优化策略
- **迁移学习**: 使用预训练模型（如ResNet、EfficientNet）
- **Fine-tuning**: 冻结底层特征提取层，只训练顶层分类器
- **学习率调度**: 使用余弦退火学习率
- **早停机制**: 验证集准确率不提升时停止训练
- **模型集成**: 结合多个模型的预测结果

## 5. 实施计划

### 5.1 开发阶段

#### 第一阶段：后端基础框架搭建（2周）
- [ ] 后端项目初始化和环境配置
- [ ] FastAPI应用框架搭建
- [ ] 基础数据模型定义（Photo, Task, DetectionResult）
- [ ] 文件上传API实现
- [ ] 基础配置管理系统
- [ ] 数据库/文件存储设计

#### 第二阶段：前端基础框架搭建（1.5周）
- [ ] 前端项目初始化（React + Vite）
- [ ] UI组件库集成（Ant Design）
- [ ] 基础页面布局搭建
- [ ] 路由配置
- [ ] 状态管理设置
- [ ] API服务封装

#### 第三阶段：核心检测功能开发（3周）
- [ ] 人脸检测和关键点提取
- [ ] 闭眼检测器实现
- [ ] 模糊检测器实现
- [ ] 曝光检测器实现
- [ ] 基本的表情检测器实现
- [ ] 构图检测器实现
- [ ] 检测器API接口实现

#### 第四阶段：核心业务功能开发（3周）
- [ ] 照片上传和存储
- [ ] 任务调度引擎
- [ ] 批量处理功能
- [ ] 多线程/多进程优化
- [ ] WebSocket实时进度推送
- [ ] 结果数据管理

#### 第五阶段：前端交互功能开发（3周）
- [ ] 照片上传界面和进度显示
- [ ] 照片网格展示组件
- [ ] 照片详情和预览功能
- [ ] 筛选和搜索功能
- [ ] 手动标记和编辑功能
- [ ] 配置管理界面
- [ ] 历史记录查看

#### 第六阶段：反馈学习系统开发（2周）
- [ ] 反馈数据模型设计
- [ ] 反馈收集API实现
- [ ] 准确率追踪系统
- [ ] 数据增强模块
- [ ] 模型训练框架搭建
- [ ] 模型评估系统
- [ ] 模型热更新机制
- [ ] 前端反馈界面

#### 第七阶段：导出和高级功能（1.5周）
- [ ] 文件导出功能
- [ ] 报告生成（CSV/JSON）
- [ ] 文件移动和复制
- [ ] 进度保存和恢复
- [ ] 错误处理和重试机制

#### 第八阶段：测试和优化（2周）
- [ ] 后端单元测试编写
- [ ] 前端组件测试
- [ ] API集成测试
- [ ] 机器学习模块测试
- [ ] 端到端测试
- [ ] 性能优化
- [ ] 准确性调优
- [ ] 模型训练测试
- [ ] Bug修复

#### 第九阶段：文档和部署（1周）
- [ ] 用户手册编写
- [ ] API文档完善
- [ ] 机器学习使用指南
- [ ] 部署文档编写
- [ ] Docker容器化配置
- [ ] 启动脚本编写
- [ ] Beta测试和反馈收集

### 5.2 里程碑

- **M1（第2周）**: 后端基础框架完成，可以接收文件上传
- **M2（第3.5周）**: 前端基础框架完成，可以访问后端API
- **M3（第6.5周）**: 核心检测功能完成，可以检测基本质量问题
- **M4（第9.5周）**: 核心业务功能完成，可以进行批量处理
- **M5（第12.5周）**: 前端交互功能完成，完整的用户界面
- **M6（第14.5周）**: 反馈学习系统完成，支持持续优化
- **M7（第16周）**: 导出和高级功能完成，核心功能齐全
- **M8（第18周）**: 测试完成，性能和准确性达标
- **M9（第19周）**: 部署准备完成，产品达到可发布状态

## 6. 风险评估与应对

### 6.1 技术风险

#### 风险1：检测准确率不达标
**影响**: 高
**概率**: 中
**应对措施**:
- 使用成熟的开源模型和算法
- 建立测试数据集进行验证
- 提供可调节的阈值参数
- 保留人工校准功能

#### 风险2：性能不满足要求
**影响**: 中
**概率**: 中
**应对措施**:
- 使用多线程/多进程处理
- 优化算法和代码
- 提供硬件加速选项
- 实现进度保存和断点续传

#### 风险3：兼容性问题
**影响**: 中
**概率**: 低
**应对措施**:
- 提前测试各种图片格式
- 使用跨平台的库
- 提供格式转换建议

### 6.2 项目风险

#### 风险1：开发时间延期
**影响**: 中
**概率**: 中
**应对措施**:
- 合理评估各功能难度
- 优先实现核心功能
- 采用敏捷开发，及时调整
- 预留缓冲时间

#### 风险2：需求变更
**影响**: 中
**概率**: 低
**应对措施**:
- 明确功能边界
- 建立变更管理流程
- 保持架构的灵活性

## 7. 验收标准

### 7.1 功能验收
- [x] 能够准确检测闭眼照片（准确率>90%）
- [x] 能够准确检测模糊照片（准确率>85%）
- [x] 支持批量处理100+张照片
- [x] 提供直观的GUI界面
- [x] 支持照片筛选和导出
- [x] 生成详细的筛选报告

### 7.2 性能验收
- [x] 单张照片处理时间<2秒
- [x] 内存占用<4GB
- [x] 程序响应流畅，无明显卡顿

### 7.3 质量验收
- [x] 通过所有单元测试
- [x] 通过集成测试
- [x] 无严重Bug
- [x] 代码符合规范
- [x] 文档完整

## 8. 后续扩展

### 8.1 高级功能（第二阶段）
- **智能评分系统**: 基于多个检测指标的综合评分
- **相似照片去重**: 识别和筛选相似照片
- **面部角度检测**: 检测是否侧面、仰拍等
- **光影质量评估**: 评估光照和阴影质量
- **背景虚化检测**: 检测背景虚化效果

### 8.2 平台扩展
- **移动端应用**: iOS/Android版本
- **云端处理**: 支持云服务和分布式处理
- **插件系统**: 支持第三方检测器

### 8.3 智能化升级
- **机器学习优化**: 基于用户反馈优化检测模型
- **个性化推荐**: 根据摄影师偏好调整筛选策略
- **自动化流程**: 与摄影工作流集成

## 9. 参考资料

### 9.1 技术文档
- OpenCV官方文档: https://docs.opencv.org/
- MediaPipe文档: https://google.github.io/mediapipe/
- FastAPI官方文档: https://fastapi.tiangolo.com/
- React官方文档: https://react.dev/
- Ant Design文档: https://ant.design/
- Vite文档: https://vitejs.dev/
- WebSocket API: https://developer.mozilla.org/en-US/docs/Web/API/WebSocket

### 9.2 算法参考
- Eye Aspect Ratio (EAR) for blink detection
- Laplacian variance for blur detection
- Histogram analysis for exposure detection

### 9.3 类似工具
- Adobe Lightroom
- Capture One
- Photo Mechanic

### 9.4 部署相关
- Docker官方文档: https://docs.docker.com/
- Python打包指南: https://packaging.python.org/
- Nginx配置指南: https://nginx.org/en/docs/

---

**文档版本**: 3.0  
**创建日期**: 2026-02-25  
**最后更新**: 2026-02-25  
**状态**: 完成（Web版本 + 反馈学习系统）

## 版本历史

### v3.0 (2026-02-25)
- 新增用户反馈学习系统
- 新增模型重训练功能
- 新增准确率追踪系统
- 新增数据增强策略
- 更新开发计划为9个阶段（19周）
- 完善机器学习技术方案

### v2.0 (2026-02-25)
- 架构从桌面应用（CS）改为Web应用（BS）
- 前端采用React框架
- 后端采用FastAPI框架
- 新增WebSocket实时进度推送
- 更新文件组织结构
- 更新部署方案为Docker容器化

### v1.0 (2026-02-25)
- 初始版本
- 桌面应用架构设计
- 基础功能定义
